<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ display_name }} 사진 업로더</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 30px;
    }
    .upload-status {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .upload-status.complete::after {
      content: " ✔️";
      color: green;
    }
    label.customer-label {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 6px;
      display: block;
    }
    #customerName {
      padding: 10px;
      font-size: 16px;
      width: 300px;
      margin-bottom: 30px;
    }
    .upload-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .thumb-box {
      width: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      box-sizing: border-box;
      transition: border 0.3s;
    }
    .thumb-box.complete {
      border: 3px solid #0ace03;
    }
    .thumb-img {
      width: 180px;
      height: 100px;
      object-fit: cover;
      margin-bottom: 10px;
    }
    .upload-input {
      margin: 6px 0;
      width: 180px;
    }
    .upload-button {
      padding: 5px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .checkmark {
      font-size: 22px;
      color: rgb(0, 177, 0);
      margin-top: 4px;
    }
    .desc-text {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      text-align: center;
      word-break: keep-all;
    }
  </style>
</head>
<body>
  <h1>🖼️ {{ display_name }} 제작 사진 업로더</h1>
  <div class="subtitle" style="line-height: 1.7;">
  📌 <strong>사진은 한 컷씩 업로드</strong> 후, '업로드하기' 버튼을 꼭 눌러주세요.<br>
  📌 <strong>처음 업로드 시</strong> 몇 초간 로딩이 걸릴 수 있습니다.<br>
  📌 업로드한 사진이 보여지면 <strong>임시저장</strong>되었으니 <strong>같은 브라우저에서는</strong> 이어서 작업 가능합니다.<br>
  📌 <strong>재업로드 시</strong> 기존 파일은 자동으로 덮어씌워집니다.<br>
  📌 <strong>'주문자-주인공' 이름은</strong> 업로드 폴더명이 되므로 <u>변경하지 마세요</u>.<br>
  📌 <strong>최초 업로드에만</strong> 사용하는 창입니다. 시안받아보시고 수정단계라면 카카오톡으로 말씀해주세요.<br>
  📌 업로드된 자료는 꿈꾸다 <strong>드라이브</strong>에 저장되며, 영업일 오전 순차 확인 후 개별 연락드립니다.<br><br>

  ❗ 오류 시 <a href="mailto:info@dream-ing.kr">info@dream-ing.kr</a> 또는
  <a href="http://pf.kakao.com/_qzxanV/chat" target="_blank" style="color:#3366cc;">카카오톡 @꿈꾸다</a> 로 문의해주세요.<br>
  📦 <strong>업로더/메일/카톡 중</strong> 셋중 편하신 곳으로 보내주세요. 어느곳이든 확인만돼면 제작 가능합니다. </div>

<!-- 안내 메시지 -->
<label class="customer-label">👤 '주문자-주인공' 이름을 적어주세요</label>

<input type="text" id="customerName" placeholder="예: 홍길동-홍길순" style="margin-bottom: 4px;">
<div style="font-size: 14px; color: #888;">
  * 위 이름이 업로드 폴더명으로 사용되므로 변경하지 마세요.
</div>

<!-- 구분선 -->
<hr style="border: none; border-top: 3px dashed #ccc; margin: 24px 0 12px 0;">

<!-- 업로드 완료 갯수 | 초기화 버튼 -->
<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
  <div id="uploadStatus"
       style="font-size: 17px; font-weight: bold; height: 32px; display: flex; align-items: center;">
    38 중 0개 업로드 완료
  </div>
  <div style="height: 16px; width: 3px; background-color: #ccc;"></div>
  <button onclick="resetUploads()"
          style="font-size: 13px; height: 32px; padding: 0 12px; display: flex; align-items: center;">
    🗑 업로드 초기화
  </button>
</div>


  <!-- 총 컷 수 -->
  <span id="totalCount" style="display:none;">{{ photo_list | length }}</span>

  <div class="upload-grid">
    {% for photo in photo_list %}
      <div class="thumb-box" id="box-{{ photo.id }}">
        <img class="thumb-img" src="/thumbs/{{ sample }}/{{ photo.id }}.jpg" alt="{{ photo.desc or '썸네일' }}">
        <strong>{{ photo.id }}</strong>
        <input type="file" id="file-{{ photo.id }}" class="upload-input">
        <button class="upload-button" onclick="uploadFile('{{ photo.id }}')">업로드하기</button>
        <div id="check-{{ photo.id }}" class="checkmark"></div>
        <div class="desc-text">{{ photo.desc }}</div>
        <img id="preview-{{ photo.id }}" class="thumb-img" style="margin-top:10px; display:none;" alt="업로드 미리보기">
      </div>
    {% endfor %}
  </div>

<!-- 생략된 상단 head, 스타일, 업로더 UI 부분은 기존 유지 -->

<script>
document.addEventListener("DOMContentLoaded", function () {
  const total = parseInt(document.getElementById('totalCount').innerText, 10);
  let uploaded = 0;
  const uploadedSet = new Set();

  const driveLinkEl = document.getElementById("driveFolderLink");

  function updateStatus() {
    const status = document.getElementById('uploadStatus');
    status.textContent = `${total} 중 ${uploaded}개 업로드 완료`;
  }

  function saveToLocal(photoId, dataUrl) {
    localStorage.setItem(`preview_${photoId}`, dataUrl);
  }

  function saveUploaded(photoId) {
    localStorage.setItem(`uploaded_${photoId}`, "true");
  }

  function loadFromLocal(photoId) {
    return localStorage.getItem(`preview_${photoId}`);
  }

  function isUploaded(photoId) {
    return localStorage.getItem(`uploaded_${photoId}`) === "true";
  }

  function saveFolderLinkToLocal(link) {
    localStorage.setItem("drive_folder_link", link);
  }

  window.uploadFile = function (photoId, fileOverride = null) {
    const fileInput = document.getElementById('file-' + photoId);
    const file = fileOverride || fileInput.files[0];
    if (!file) {
      alert('사진을 먼저 선택해주세요!');
      return;
    }

    const customerName = document.getElementById('customerName').value.trim();
    if (!customerName) {
      alert('주문자-주인공 이름을 입력해주세요!');
      return;
    }

    let finalFile = file;
    if (!file.name.includes('.')) {
      finalFile = new File([file], file.name + '.jpg', { type: file.type });
    }

    const formData = new FormData();
    formData.append('file', finalFile);
    formData.append('customer_name', customerName);

    fetch(`/upload_file/{{ sample }}/${photoId}`, {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok') {
        alert(`${photoId}번 사진 업로드 성공!`);
        document.getElementById('check-' + photoId).innerText = '✔️';
        document.getElementById('box-' + photoId).classList.add('complete');
        saveUploaded(photoId);

        const reader = new FileReader();
        reader.onload = function (e) {
          const previewImg = document.getElementById('preview-' + photoId);
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
          saveToLocal(photoId, e.target.result);
        };
        reader.readAsDataURL(finalFile);

        if (!uploadedSet.has(photoId)) {
          uploadedSet.add(photoId);
          uploaded++;
          updateStatus();
        }

        // ✅ 폴더 링크 저장 및 하단 링크 갱신
        if (data.folder_link) {
          driveLinkEl.href = data.folder_link;
          driveLinkEl.style.display = 'inline-block';
          saveFolderLinkToLocal(data.folder_link);
        }

      } else {
        alert(`❌ 업로드 실패: ${data.message || '알 수 없는 오류'}`);
      }
    })
    .catch(err => {
      alert(`❌ 업로드 중 예외 발생: ${err}`);
    });
  };

  // ✅ 업로드 상태 복원
  {% for photo in photo_list %}
    const savedPreview_{{ photo.id }} = loadFromLocal("{{ photo.id }}");
    if (savedPreview_{{ photo.id }}) {
      const previewImg = document.getElementById("preview-{{ photo.id }}");
      previewImg.src = savedPreview_{{ photo.id }};
      previewImg.style.display = 'block';
    }

    if (isUploaded("{{ photo.id }}")) {
      document.getElementById('check-{{ photo.id }}').innerText = '✔️';
      document.getElementById('box-{{ photo.id }}').classList.add('complete');
      uploadedSet.add("{{ photo.id }}");
      uploaded++;
    }
  {% endfor %}

  updateStatus();

  // ✅ 폴더 링크 복원
  const storedLink = localStorage.getItem("drive_folder_link");
  if (storedLink) {
    driveLinkEl.href = storedLink;
    driveLinkEl.style.display = 'inline-block';
  }

  // ✅ 주문자 이름 로컬 저장/복원
  const nameInput = document.getElementById('customerName');
  const storedName = localStorage.getItem('customer_name');
  if (storedName) {
    nameInput.value = storedName;
  }
  nameInput.addEventListener('input', function () {
    localStorage.setItem('customer_name', nameInput.value.trim());
  });

  // ✅ 초기화
  window.resetUploads = function () {
    if (confirm('정말 초기화하시겠습니까?\n브라우저 기록이 삭제되며 새로고침됩니다.')) {
      localStorage.clear();
      location.reload();
    }
  };
});
</script>


<!-- 나머지 하단 드라이브 링크 구역 등은 유지 -->


<!-- 구분선 -->
<hr style="margin: 40px 0 20px 0; border-top: 1px dashed #ccc;">

<!-- 추가 자료 업로드 섹션 -->
<div id="extra-upload-section" style="text-align: center;">
  <h3 style="font-size: 18px; margin-bottom: 10px;"> 🔍 업로드된 자료 확인하기</h3>

  <!-- 버튼: 드라이브 링크 열기 -->
  <a id="driveFolderLink" href="#" target="_blank" style="
      display: inline-block;
      padding: 10px 18px;
      background-color: #f0f0f0;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      color: #333;
      text-decoration: none;
      border: 1px solid #ccc;
    ">📂내 폴더보기</a>

  <!-- 설명 텍스트 -->
  <div style="margin-top: 12px; font-size: 13px; color: #777; line-height: 1.6;">
    고객님께서 업로드하신 사진은 <strong>전용 폴더</strong>에 안전하게 저장됩니다.<br>
    위 버튼을 눌러 업로드가 잘 되었는지 확인해보세요.<br>
    해당 폴더는 현재 창에있는 고객님만 열람할 수 있으며,(보기만가능) 외부에는 공개되지 않습니다.
    ※ 영상편지 추가구매 등, 동영상 추가 자료가 있다면 카카오톡 또는 이메일로 <strong>별도 전달</strong> 부탁드립니다 ※
  </div>
</div>


</body>
</html>
